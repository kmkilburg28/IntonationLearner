<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Tone Nation</title>
	<script src="Chart.min.js"></script>
	<script src="utils.js"></script>
	<script src="yin.min.js"></script>
	<script src="RawData.js" type="text/javascript"></script>
	<script src="FrequencyData.js" type="text/javascript"></script>
	<script src="AudioFileHelpers.js" type="text/javascript"></script>
	<script src="PitchDetection.js" type="text/javascript"></script>
	<script src="AudioRecorder.js" type="text/javascript"></script>
	<script src="ModelSegment.js" type="text/javascript"></script>
	<script src="Normalization.js" type="text/javascript"></script>
	<script src="CorrelationMSE.js" type="text/javascript"></script>
	<script src="SmoothingSpline.js" type="text/javascript"></script>
	<script src="lz-string.min.js" type="text/javascript"></script>
    <script src="SegmentFormat.js" type="text/javascript"></script>
    <script src="DTW.js" type="text/javascript"></script>
</head>
<body>
	<h2>Results</h2>
	<div>
		<button onclick="document.location='index.html'">Exit</button>
		<button id="playButtonModel">Listen</button>
		<script>
			const AudioContext = window.AudioContext || window.webkitAudioContext; 
			/** @type {AudioContext} */
			const audioContext = new AudioContext();
			// const params = new URLSearchParams(window.location.search);
			// if (params.has("uploaded")) {} // TODO

			const modelFileName = localStorage.getItem('modelfile');
			const filePath = "Model Speaker Files/" + modelFileName + ".wav";

			async function demoAudio() {
				const baseURL = "https://kmkilburg28.github.io/IntonationLearner/";
				const audioBuffer = await loadAudioFile(baseURL + filePath);
				const parsedAudio = parseAudioBuffer(audioBuffer);
				const frequencies = getFrequencies(parsedAudio);
				playAudioBuffer(audioBuffer, 1);
				return frequencies;
			};
			const listenButton = document.getElementById('playButtonModel');
			listenButton.addEventListener('click', demoAudio);
		</script>
		<div class="container" style="width:40%;"></div>
		<br>
		<div>
			<button id="playUser">Play Recording</button>
		</div>

	</div>
	<script type="text/javascript">
		function createConfig(pointStyle) {
			return {
				type: 'line',
				data: {
					labels: [],
					datasets: [{
						label: 'Model',
						backgroundColor: window.chartColors.red,
						borderColor: window.chartColors.red,
						data: [],
						fill: false,
						pointRadius: 2,
						pointHoverRadius: 15,
						showLine: false // no line shown
					}, {
						label: 'ModelSmooth',
						backgroundColor: window.chartColors.blue,
						borderColor: window.chartColors.blue,
						data: [],
						fill: false,
						pointRadius: 2,
						pointHoverRadius: 15,
						showLine: false // no line shown
					}, {
						label: 'User',
						backgroundColor: window.chartColors.blue,
						borderColor: window.chartColors.blue,
						data: [],
						fill: false,
						pointRadius: 2,
						pointHoverRadius: 15,
						showLine: false // no line shown
					}, {
						label: 'UserSmooth',
						backgroundColor: window.chartColors.green,
						borderColor: window.chartColors.green,
						data: [],
						fill: false,
						pointRadius: 2,
						pointHoverRadius: 15,
						showLine: false // no line shown
					}]
				},
				options: {
					responsive: true,
					title: {
						display: true,
						text: 'Frequency Graph'
					},
					legend: {
						display: false
					},
					elements: {
						point: {
							pointStyle: pointStyle
						}
					},
					scales: {
						yAxes: [{
							ticks: {
								//min: 0.0,
								//max: 1.0
							}
						}]
					},
					// animation: {
					// 	duration: 10,
					// 	easing: 'linear'
					// }
					animation: undefined
				}
			};
		}

		window.onload = async function() {
			var container = document.querySelector('.container');

			var div = document.createElement('div');
			div.classList.add('chart-container');

			var canvas = document.createElement('canvas');
			div.appendChild(canvas);
			container.appendChild(div);

			var ctx = canvas.getContext('2d');
			var config = createConfig('circle');
			const chart = new Chart(ctx, config);


			const baseURL = "https://kmkilburg28.github.io/IntonationLearner/";
			const audioBuffer = await loadAudioFile(baseURL + filePath);
			const parsedAudio = parseAudioBuffer(audioBuffer);
			const frequenciesModel = getFrequencies(parsedAudio);
			// plotFrequencies(frequenciesModel, chart, "Model");
			

			const rawUser = stringToRawData(LZString.decompress(localStorage.getItem("userRecording")));
			const playButtonUser = document.getElementById("playUser");
			playButtonUser.addEventListener('click', () => {
				const audioBuffer = audioContext.createBuffer(
					1,
					rawUser.buffer.length,
					rawUser.sampleRate
				);
				audioBuffer.getChannelData(0).set(rawUser.buffer);
				const source = audioContext.createBufferSource();
				source.buffer = audioBuffer;
				// const gainNode = audioContext.createGain();
				// gainNode.gain.value = 1;
				// source.connect(gainNode);
				// gainNode.connect(audioContext.destination);
				source.connect(audioContext.destination);
				source.start(0);
			});

			const frequenciesUser = getFrequencies(rawUser);			

			const normalizedModel = trim(NormalizeArray(frequenciesModel.buffer)).map(value => value == 0 ? -Infinity: value);
			const noramlizedUser  = trim(NormalizeArray(frequenciesUser.buffer)).map(value => value == 0 ? Infinity: value);
			for(let i = 0; i < normalizedModel.length || i < noramlizedUser.length; i++){
				chart.data.labels[i] = i;
			}
			chart.data.datasets[0].data = normalizedModel;
			chart.data.datasets[1].data = noramlizedUser;
			chart.update();
			/** @type {{model, user}} */
			const segmentedAudio = warp(normalizedModel, noramlizedUser);
			console.log(segmentedAudio);
			const co = new Float32Array(segmentedAudio.model.length);
			const mse = new Float32Array(segmentedAudio.model.length);
			for (let i = 0; i < segmentedAudio.model.length; ++i) {
				
				mse[i] = MSE(segmentedAudio.model[i], segmentedAudio.user[i]);

				const SplineArrayModel = getSplineFromArray(segmentedAudio.model[i]);
				//console.log(SplineArrayModel);

				let lastRealIndex = 0;
				for (let x = 0; x < segmentedAudio.model[i].length; x++) {
					if(!isFinite(segmentedAudio.model[i][x])){
						segmentedAudio.model[i][x] = SplineArrayModel[lastRealIndex].evaluate(x);
					}else{
						lastRealIndex++;
					}
				}
				console.log(segmentedAudio.model[i]);
				co[i]  = correlationCoe(segmentedAudio.model[i], segmentedAudio.user[i]);
				const SplineArrayUser = getSplineFromArray(segmentedAudio.model[i]);
				//plotSpline(SplineArrayUser, chart, "UserSmooth");
			}
			console.log(co, mse);


		};
	</script>
	

</body>
</html>